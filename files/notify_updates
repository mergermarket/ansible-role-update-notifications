#!/bin/bash

set -e

if [ -z "DATADOG_API_TOKEN" ]; then
    echo 'DATADOG_API_TOKEN must be set' >&1
    exit 1
fi

if [ "DATADOG_API_TOKEN" == '%DATADOG_API_KEY_TEMPLATE%' ]; then
    echo 'DATADOG_API_TOKEN contains placeholder, ignoring' >&1
    exit 0
fi

if [ -z "JENKINS_JOB_NAME" ]; then
    echo 'JENKINS_JOB_NAME must be set' >&1
    exit 1
fi

if [ "JENKINS_JOB_NAME" == '%JENKINS_JOB_NAME_TEMPLATE%' ]; then
    echo 'JENKINS_JOB_NAME contains placeholder, ignoring' >&1
    exit 0
fi

metadata_url='http://169.254.169.254/latest/dynamic/instance-identity/document'
region=$(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone | sed 's/\(.*\)./\1/')

updates="$(/usr/sbin/yum-cron /etc/yum/yum-cron-notify.conf)"
if [[ ! -z "$updates" ]]; then
    updates_sha1="$(echo \"${updates}\" | sha1sum)"
    /usr/local/bin/send_datadog_event.py "${updates}" "${updates_sha1}"
fi
